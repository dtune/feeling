<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE Formula-definition SYSTEM "Formula-definition.dtd">
<!-- 商品毎に計算公式はここに定義する -->
<Formula-definition>
	<BizExpenses desc="事業費率の設定">
		<formula name="alpha" paras="n">
			roundDown(0.006*min(n/10,1),8)
		</formula>
		<formula name="delta" fraction="3" paras="n">
			if(kaisu==1){
			    max{0.04-0.01/5*max{x+n-55,0},0}
			}else{
			    max{0.06-0.01/5*max{x+n-55,0},0}
			}
 		</formula>
		<formula name="gamma">
			if(gen==1){0.00115}
			elseIf(gen==5){0.00126}
			else{0.00105}
		</formula>
		<formula name="gamma_nashu" value="0.001"/>
		<formula name="beta" value="0.03"/>
		<formula name="zeta">
			if(gen==1){0.04}
			elseIf(gen==2){0.03}
			else(0.025)
		</formula>
		<formula name="epsilon" paras="m">
			if(m&lt;=5){0.0005}
			elseIf(m&gt;5&amp;&amp;m&lt;=10){0.001}
			else{0.002}
		</formula>
	</BizExpenses>
	
	<Common desc="商品内部の共通公式">
		<formula name="qx0DD" paras="contractUpdType">
			if(gen==5){
				if(contractUpdType==1){
					<!-- 更新契約 -->
					qxDD1[x]
				}else{
					<!-- 新契約 -->
					1/4*(3*qxDD1[x]+qxDD2[x])
				}
			}else{
				1/4*(3*qxDD1[x]+qxDD2[x])
			}
		</formula>
		<formula name="qx1DD">
			if(gen==5){
				qxDD1[x]
			}else{
				1/4*(3*qxDD1[x]+qxDD2[x])
			}
		</formula>
		
		<!-- これからは自定義公式 -->
		<formula name="a_x_m_DD" paras="x,m" fraction="5">
			if(m&lt;=0){
				0
			}else{
				(N[x]-N[x+m])/D[x]
			}			
		</formula>
		<formula name="s_a_x_m_DD" paras="x,m,qxDD" fraction="5">
			1+v*(1-qxDD)*a_x_m_DD(x+1,m-1)	
		</formula>
		<formula name="a_x_m_DD_12" paras="x,m" fraction="5">
			(N[x]-N[x+m])/D[x]-11/24*(1-D[x+m]/D[x])
		</formula>
		<formula name="s_a_x_m_DD_12" paras="x,m,qxDD" fraction="5">
			13/24+v*(1-qxDD)*(11/24+a_x_m_DD_12(x+1,m-1))
		</formula>
		<formula name="m_a_x_n_DD" paras="m,x,n" fraction="5">
			(N[x+m]-N[x+n])/D[x]
		</formula>
		<formula name="s_m_a_x_n_DD" paras="m,x,n,qxDD" fraction="5">
			v*(1-qxDD)*m_a_x_n_DD(m-1,x+1,n-1)
		</formula>
		<formula name="A_x_n_D_DD" paras="x,n" fraction="6">
			1/D[x]*sum(0,n-1)(C[x+index])
		</formula>
		<formula name="s_A_x_n_D_DD" paras="x,n,qxDD" fraction="6">
			v^(1/2)*qxDD+v*(1-qxDD)*A_x_n_D_DD(x+1,n-1)
		</formula>
		
		<!-- これからは共通公式 -->
		<formula name="PrateByPaymode" paras="stdPrate,d" fraction="6" desc="払込方法別Prate">
			<formula name="Discount" paras="d" desc="高額割引">
				if(kaisu==1){0}
				elseIf(kaisu==2){12*d}
				elseIf(kaisu==3){6*d}
				else{d}
			</formula>
			stdPrate*PayFactor(kaisu,gen,keiro)-Discount(d)
		</formula>
		<formula name="S2P" paras="SBasePrate" desc="S基準からP基準に変換する">
			<!-- 普通の場合 -->
			if(kaisu==1){
				round(1/SBasePrate,4)
			}else{
				round(1/SBasePrate,2)
			}
		</formula>
	</Common>
	
	<!-- 保険料　ここから -->
	<Premium desc="保険料">
		<formula name="Prate_Sub" paras="qxDD" desc="基準Prate(sub)">
			if(kaisu==1){singlePrate}else{MultiPrate(qxDD)}
			<formula name="singlePrate" fraction="5" desc="一時払いPレート">
				(s_A_x_n_D_DD(x,n,qx0DD(contractUpdType))+alpha(n)+gamma_nashu*s_a_x_m_DD(x,n,qx0DD(contractUpdType)))
				/(1-delta(n))
			</formula>
			<formula name="MultiPrate" paras="qxDD" fraction="6" desc="分割払いPレート">
				if(m==n){
					if((x+n)&lt;90){
						set{s=n}
						set(Prate_tmp=MultiPrateCompare(s,qxDD))
						while(s&lt;(90-x)){
							Prate_tmp = min(Prate_tmp,MultiPrateCompare(s,qxDD)}
						    set{s=s+1}	
						}
					}else{
						(s_A_x_n_D_DD(x,n,qxDD)+alpha(n)+gamma*s_a_x_m_DD_12(x,n,qxDD))
						/{12*(1-beta-zeta-delta(n)-epsilon(m))*s_a_x_m_DD_12(x,n,qxDD)}
					}
				)elseIf(m&lt;n){
					(s_A_x_n_D_DD(x,n,qxDD)+alpha(n)+gamma*s_a_x_m_DD_12(x,m,qxDD)+gamma_nashu*s_m_a_x_n_DD(m,x,n,qxDD))
					/{12*(1-beta-zeta-delta(n)-epsilon(m))*s_a_x_m_DD_12(x,m,qxDD)}
				}else{0}
			</formula>
			<formula name="MultiPrateCompare" paras="s,qxDD" desc="分割払いPレート(比較用)">
				(s_A_x_n_D_DD(x,s,qxDD)+alpha(s)+gamma*s_a_x_m_DD_12(x,s,qxDD))
				/{12*(1-beta-zeta-delta(s)-epsilon(s))*s_a_x_m_DD_12(x,s,qxDD)}
			</formula>	
		</formula>
		<formula name="stdPrate" pvh="P" desc="基準Ｐレート">
			Prate_Sub(qx1DD)
		</formula>
		<formula name="Prate" pvh="P" accessable="true" desc="１．保険料レート">
			PrateByPaymode(stdPrate,0)
		</formula>
		<formula name="adjustStdPrate" desc="調整基準Pレート">
			if(gen==5){
				if(kaisu==1){
					0
				}else{
					PrateByPaymode(Prate_Sub(qx1DD),0)-PrateByPaymode(Prate_Sub(qx0DD(0)),0)
				}
			}else{0}
		</formula>
		<formula name="adjustPrate" pvh="P" desc="調整P実額">
			if(contractUpdType==1){
				<!-- 更新契約 -->
				0
			}else{
				<!-- 新契約 -->
				round(SA*adjustStdPrate,0)
			}
		</formula>
			
		<formula name="PrateByYear" pvh="P" fraction="6" desc="年払Prate">
			stdPrate*PayFactor(2,gen,1)
		</formula>
		<!-- OL用計算公式 -->
		<formula name="Premium" pvh="P" paras="stdPrate" accessable="true" desc="２．保険料・保険金">
			if(sptate==0){
				roundDown(SA*max{PrateByPaymode(stdPrate,0),0},0)
			}else{
				roundUp(
					roundDown(
						SA*S2P(PrateByPaymode(stdPrate,0))
						,0)/1000
				,0)*1000
			}
		</formula>
	</Premium>

	<!-- 責任準備金　ここから -->
	<ReserveFund desc="責任準備金">
		<formula name="Vrate_endofYear_sub1" paras="t,z" desc="保険料払込期間中 または払込免除">
			<formula name="az">
				0.008*min(n/10,1)
			</formula>
			if(t==0){
				0
			}else{
				max{
					A_x_n_D_DD(x+t,n-t)+gamma_nashu*a_x_m_DD(x+t,n-t)
					-(s_A_x_n_D_DD(x,n,qx0DD(contractUpdType))+gamma_nashu*s_a_x_m_DD(x,n,qx0DD(contractUpdType)))
					/s_a_x_m_DD(x,m,qx0DD(contractUpdType))*a_x_m_DD(x+t,m-t)
					-if(z==0){0}else{az/s_a_x_m_DD(x,z,qx0DD(contractUpdType))*a_x_m_DD(x+t,z-t)}
				,0}
			}
		</formula>
		<formula name="Vrate_endofYear_sub2" paras="t" desc="保険料払込期間終了">
			if(t==0){
				s_A_x_n_D_DD(x+t,n-t,qx0DD(contractUpdType))+gamma_nashu*s_a_x_m_DD(x+t,n-t,qx0DD(contractUpdType))
			}else{
				A_x_n_D_DD(x+t,n-t)+gamma_nashu*a_x_m_DD(x+t,n-t)
			}
		</formula>
		
		<formula name="Vrate_accu" paras="t,z" desc="保険年度末rate">
			if(kaisu==1||state==2){
				<!-- 保険料払込期間終了の場合 -->
				Vrate_endofYear_sub2(t)
			}elseIf{state==1||state==6}{
				<!-- 保険料払込期間中 または払込免除の場合 -->
				Vrate_endofYear_sub1(t,z)
        	}else{0}
		</formula>
		<!-- 保険年度末保険料積立金レート　ここから -->
		<formula name="Vrate" paras="t" pvh="if(gen&gt;2){H}else{V}" fraction="4" accessable="true" desc="１．保険年度末Vレート">
			Vrate_accu(t,0)
		</formula>
		<!-- 契約者用Vレート -->

		<formula name="ContractorYearV" paras="t,z" pvh="P" fraction="4" desc="契約者保険年度Vrate">
			Vrate_accu(t,z)
		</formula>

		<formula name="ContractorVrate" fraction="4" pvh="P" accessable="true" desc="３．契約者用Vレート">
			if(kaisu==1||state==2){
				<!-- 一時払 -->
				(1-f_12(f))*ContractorYearV(t,z)+f_12(f)*ContractorYearV(t+1,z)
			}elseIf(state==1||state==6){
				<!-- 保険料払込期間中(保険料払込免除を含む) -->
			  	(1-f_12(f1))*ContractorYearV(t1,z)+f_12(f1)*ContractorYearV(t1+1,z)
			}else{0}
		</formula>

		<formula name="Vratebiz_endofYear_Sub3">
			(s_A_x_n_D_DD(x,n,qx0DD(contractUpdType))+gamma_nashu*s_m_a_x_n_DD(m,x,n,qx0DD(contractUpdType)))
					/
			s_a_x_m_DD(x,m,qx0DD(contractUpdType))
		</formula>
		
		<formula name="Vratebiz_endofYear_Sub1" paras="t,z" fraction="4" desc="事業年度末用保険年度末Vレート(SUB1)">
			<formula name="az">
				0.008*min(n/10,1)
			</formula>
			max{
				A_x_n_D_DD(x+t,n-t)+gamma_nashu*a_x_m_DD(x+t,n-t)
				-(PrateByYear+gamma_nashu)*a_x_m_DD(x+t,m-t)
				-if(z==0){0}else{az/s_a_x_m_DD(x,z,qx0DD(contractUpdType))*a_x_m_DD(x+t,z-t)}
			,0}
		</formula>
		
		<formula name="BizYearV" paras="t,z" accessable="false" desc="事業末Vレート">
        	if(kaisu==1||state==2||state==6){
        		Vrate_endofYear_sub2(t)
        	}elseIf(state==1){
        		<!-- 保険料払込期間中 の場合 -->
        		if(t==0){
        			0
        		}else{
        			if(round(Vratebiz_endofYear_Sub3,6)&lt;=PrateByYear){
        				Vrate_endofYear_sub1(t,z)
        			}else{
        				Vratebiz_endofYear_Sub1(t,z)
        			}
        		}
        	}else{
        		0
        	}
		</formula>
		
		<formula name="calBizYearV" fraction="4" desc="事業末用Vレート">
			BizYearV(t,z)
		</formula>

	</ReserveFund>
	
	<!-- 解約返戻金　ここから -->
	<SurrenderFee desc="解約返戻金">
		<formula name="tWrate" paras="t" fraction="4" pvh="P">
			<formula name="sigma" paras="t">
				0.006*min(n/10,1)
                *max{1-t/min(m,10),0}
			</formula>
			if(state==1||state==6){
		     	<!--払込期間中　または　免除 -->
			  	max{ContractorYearV(t,0)-sigma(t),0)
			}else{
		  		max{ContractorYearV(t,0),0}
			}
		</formula>
		<formula name="Wrate" fraction="4" pvh="P" accessable="true" desc="１．解約返戻金Wレート">
			<formula name="Wrate_Sub1">
				if((12*t1+f1-12*t-f)&lt;0){
				<!-- 払込年月数-経過年月数<0の場合、t,fをt1,f1に読み替え -->
           		  (1-f_12(f1))*tWrate(t1)+f_12(f1)*tWrate(t1+1)
           		}else{
           		  (1-f_12(f))*tWrate(t)+f_12(f)*tWrate(t+1)
           		}
			</formula>
			<formula name="Wrate_Sub2">
				(1-f_12(f))*tWrate(t)+f_12(f)*tWrate(t+1)
			</formula>
			<formula name="Wrate_Sub4">
				v^ve*round((1-f_12(f1))*tWrate(t1)+f_12(f1)*tWrate(t1+1),4)
			</formula>
			<formula name="Wrate_Sub5">
				v^ve
				*round((1-f_12(f1))*min{tWrate(t1),Wrate_Sub6(t1,min(m,5))}
				+f_12(f1)*min(tWrate(t1+1),Wrate_Sub6(t1+1,min(m,5))),4)
			</formula>
			<formula name="Wrate_Sub6" pvh="V" fraction="4" paras="t,z">
				Vrate_endofYear_sub1(t,z)
			</formula>
			if(kaisu==1||state==2){
				<!-- 一時払 -->
				Wrate_Sub2
			}elseIf(state==1||state==6){
			  	if(PremiumAbolishSign==1){
			    	Wrate_Sub1
			  	}elseIf(contractDate&gt;=20080202){
			    	Wrate_Sub4
			  	}else{
			    	Wrate_Sub5
			  	}
			}else{0}
		</formula>
	</SurrenderFee>	
</Formula-definition>