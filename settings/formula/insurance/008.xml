<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE Formula-definition SYSTEM "Formula-definition.dtd">
<!-- 商品毎に計算公式はここに定義する -->
<Formula-definition>
	<BizExpenses desc="事業費率の設定">
		<!-- 死亡率qDD -->
		<formula name="qDDx" desc="死亡率qDD">
			(1/4)*(3*qxDD1[x]+qxDD2[x])
		</formula>
		
		<!-- 予定事業費率、ここから  -->
		<formula name="alpha" value="0.02" desc="新契約費α"/>
		<formula name="delta" paras="m" desc="新契約費δ">
			if(kaisu==1){
				0
			}else{
				roundDown{0.02*min{max{m,10}/20,1},8}
			}
		</formula>
		<formula name="gamma" desc="維持費（払込中）γ">
			if(gen==1){0.00215}elseIf(gen==5){0.00246}else{0.00205}
		</formula>
		<formula name="gamma_nashu" value="0.002" desc="維持費（一時払）γ'"/>
		<formula name="gamma1" value="0.001" desc="維持費（死亡）γ1"/>
		<formula name="gamma2" value="0.001" desc="維持費（生存）γ2"/>
		<formula name="beta" value="0.03" desc="集金費β"/>
		<formula name="zeta" desc="集金費ζ">
			if(gen==1){0.04}elseIf(gen==2){0.03}else{0.025}
		</formula>
		<formula name="epsilon" paras="m" desc="保険料払込免除ε">
			if(m&lt;=5){0.0005}elseIf(m&gt;10){0.002}else{0.001}
		</formula>
		
		<!-- 高額割引率d  -->
		<formula name="d" desc="高額割引率d">
			if(SA&lt;10000000){
				if(gen==3||gen==4||gen==5){0}else{0}
			}elseIf(SA&gt;=10000000 &amp;&amp; SA&lt;30000000){
				0.00002
			}else{
				if(gen==3||gen==4||gen==5){0.00003}else{0.00002}
			}
		</formula>
	</BizExpenses>
	
	<Common desc="商品内部の共通公式">
		<!-- 終身払場合、Prate用払込期間ｍ -->	
		<formula name="Pmshushin" desc="Prate用払込期間ｍ">
			if(m==99){
				omega-x+1
			}else{		
				m
			}
		</formula>	
		<!-- 終身払場合、払込期間ｍ -->	
		<formula name="mshushin" desc="払込期間ｍ">
			if(state==7){
				if(m==99 || x+m&gt;80){80-x}else{m}
			}else{
				if(m==99){
					omega-x+1
				}else{
					m
				}
			}
		</formula>
		<!-- 生命年金現価、ここから  -->
		<formula name="aDD_x" paras="x" fraction="5">
			N[x]/D[x]
		</formula>
		<formula name="SaDD_x" paras="x" fraction="5">
			1+v*(1-qDDx)*aDD_x(x+1)
		</formula>
		<formula name="aDD_x_m" paras="x,m" fraction="5">
			if(m&lt;=0){0}else{(N[x]-N[x+m])/D[x]}
		</formula>
		<formula name="SaDD_x_m" paras="x,m" fraction="5">
			1+v*(1-qDDx)*aDD_x_m(x+1,m-1)
		</formula>
		<formula name="aDD_x_m_k" paras="x,m" fraction="5">
			(N[x]-N[x+m])/D[x]-(11/24)*(1-D[x+m]/D[x])
		</formula>
		<formula name="SaDD_x_m_k" paras="x,m" fraction="5">
			13/24+v*(1-qDDx)*(11/24+aDD_x_m_k(x+1,m-1))
		</formula>
		<formula name="m_aDD_x" paras="x,m" fraction="5">
			N[x+m]/D[x]
		</formula>
		<formula name="m_SaDD_x" paras="x,m" fraction="5">
			v*(1-qDDx)*m_aDD_x(x+1,m-1)
		</formula>
		
		<!-- 給付現価、ここから  -->
		<formula name="ADD_x_l" paras="x" fraction="6">
			(1/D[x])*sum(0,omega-x){C[x+index]}
		</formula>
		<formula name="SADD_x_l" paras="x" fraction="6">
			v^(1/2)*qDDx+v*(1-qDDx)*ADD_x_l(x+1)
		</formula>
		<formula name="ADD_D_x_n_l" paras="x,n" fraction="6">
			(1/D[x])*sum(0,n-1){C[x+index]}
		</formula>
		<formula name="ADD_x_n_l" paras="x,n" fraction="6">
			D[x+n]/D[x]
		</formula>
		
		<!-- 下記の分割払いの係数定義は商品に問わずため、外部の共通commonフォルダに移す -->
		<formula name="PrateByPaymode" paras="stdPrate,d" fraction="6" desc="払込方法別Prate">
			<!-- 基準Prateと高額割引dより、払込方法別Prateを求める -->
			<formula name="Discount" paras="d" desc="高額割引">
				if(kaisu==1){0}
				elseIf(kaisu==2){12*d}
				elseIf(kaisu==3){6*d}
				else{d}
			</formula>
			stdPrate*PayFactor(kaisu,gen,keiro)-Discount(d)
		</formula>
		<formula name="S2P" paras="SBasePrate" desc="S基準からP基準に変換する">
			if(kaisu==1){
				round(1/SBasePrate,4)
			}else{
				round(1/SBasePrate,2)
			}
		</formula>
	</Common>
	
	<Premium desc="保険料">
		<formula name="SingleP" fraction="5" desc="一時払Pレート">
			SADD_x_l(x)+alpha+gamma_nashu*SaDD_x(x)
		</formula>
		<formula name="MultiP" fraction="6" desc="分割払Pレート">
			if(m==99){
				{SADD_x_l(x)+alpha+gamma*SaDD_x_m_k(x,Pmshushin)}
						/
				{12*(1-beta-zeta-delta(Pmshushin)-epsilon(Pmshushin))*SaDD_x_m_k(x,Pmshushin)}
			}else{
				{SADD_x_l(x)+alpha+gamma*SaDD_x_m_k(x,Pmshushin)+gamma_nashu*m_SaDD_x(x,Pmshushin)}
						/
				{12*(1-beta-zeta-delta(Pmshushin)-epsilon(Pmshushin))*SaDD_x_m_k(x,Pmshushin)}
			}
		</formula>
		<formula name="stdPrate" pvh="P" accessable="false" desc="基準保険料レート">
			if(kaisu==1){<!--　ここから、 一時払い開始 -->
				SingleP
			}else{<!--　ここから、 分割払い開始 -->
				MultiP
			}
		</formula>
		<formula name="Prate" pvh="P" accessable="true" desc="１．保険料レート">
			PrateByPaymode(stdPrate,d)
		</formula>
		<formula name="PrateByYear" fraction="6" desc="年払Prate">
			stdPrate*PayFactor(2,gen,1)-12*d
		</formula>	
		<formula name="Premium" pvh="P" accessable="true" desc="２．保険料・保険金">
			<!-- 高額割引がゼロ 100円の位を切り上げ-->
			if(sptate==0){
				<!-- Ｐレートはゼロより小さい場合、ゼロとする -->
				roundDown(SA*max{Prate,0},0)
			}else{
				roundUp(roundDown(SA*S2P(Prate),0)/1000,0)*1000
			}
		</formula>
	</Premium>
	
	<ReserveFund desc="保険積立金">
		<formula name="SingleV" paras="t" desc="一時払VTレート">
			if(x+t&gt;=129){0}elseIf(x+t==109&amp;&amp;sex==1){0}elseIf(x+t&gt;omega){1}else{
				if(t==0){
					SADD_x_l(x+t)+gamma_nashu*SaDD_x(x+t)
				}else{
					ADD_x_l(x+t)+gamma_nashu*aDD_x(x+t)
				}
			}
		</formula>
		<formula name="MultiV" paras="t,z" desc="払込中（免除）VTレート">
			if(x+t&gt;=129){0}elseIf(x+t==109&amp;&amp;sex==1){0}elseIf(x+t&gt;omega){1}else{
				if(gen==5){
					if(t==0){
						0
					}else{
						if(m==99){
							ADD_x_l(x+t)-SADD_x_l(x)*aDD_x_m(x+t,mshushin-t)/SaDD_x_m(x,mshushin)
							-
							if(z==0){0}else{alpha*aDD_x_m(x+t,z-t)/SaDD_x_m(x,z)}
						}else{
							ADD_x_l(x+t)+gamma_nashu*aDD_x(x+t)
							-
							(SADD_x_l(x)+gamma_nashu*SaDD_x(x))*aDD_x_m(x+t,mshushin-t)/SaDD_x_m(x,mshushin)
							-
							if(z==0){0}else{alpha*aDD_x_m(x+t,z-t)/SaDD_x_m(x,z)}
						}
					}
				}else{
					if(t==0){
						0
					}else{
						max{
							if(m==99){
								ADD_x_l(x+t)-SADD_x_l(x)*aDD_x_m(x+t,mshushin-t)/SaDD_x_m(x,mshushin)
								-
								if(z==0){0}else{alpha*aDD_x_m(x+t,z-t)/SaDD_x_m(x,z)}
							}else{
								ADD_x_l(x+t)+gamma_nashu*aDD_x(x+t)
								-
								(SADD_x_l(x)+gamma_nashu*SaDD_x(x))*aDD_x_m(x+t,mshushin-t)/SaDD_x_m(x,mshushin)
								-
								if(z==0){0}else{alpha*aDD_x_m(x+t,z-t)/SaDD_x_m(x,z)}
							}
						,0}
					}
				}
			}
		</formula>
		<formula name="live" paras="t,tEX" fraction="4" desc="延長定期保険VTレート（生存部分）">
			ADD_x_n_l(x+t,tEX-t)+gamma2*aDD_x_m(x+t,tEX-t)
		</formula>
		<formula name="dead_sub1" paras="t,tEX" fraction="4">
			ADD_D_x_n_l(x+t,tEX-t)+gamma1*aDD_x_m(x+t,tEX-t)
		</formula>
		<formula name="dead" paras="t,tEX,fEX" fraction="4" desc="契約日からの保険期間nEXに端月数がある場合死亡部分">
			if(t&lt;tEX){
				round(1-fEX/12,5)*dead_sub1(t,tEX)+round(fEX/12,5)*dead_sub1(t,tEX+1)
			}elseIf(t==tEX){
				round(fEX/12,5)*dead_sub1(t,tEX+1)
			}else{0}
		</formula>
		
		<formula name="Vrate_accu" paras="t,z" desc="保険年度末rate">
			if(kaisu&gt;1){	
				if(state==4){
					<!-- 払済 -->
					SingleV(t)
				}elseIf(state==1 || state==6){
					<!-- 払込期間中まだは免除 -->
					MultiV(t,z)
				}elseIf(state==2){
					<!-- 払込期間終了後 -->
					SingleV(t)
				}elseIf(state==7){
					if(SAS!=0){
						live(t,tEX)
					}else{
						dead(t,tEX,fEX)
					}
				}else(0)
			}elseIf(kaisu==1){
				<!-- 一時払 -->
				SingleV(t)
			}else{0}
		</formula>
		<formula name="Vrate" pvh="if(gen&lt;3){V}else{H}" fraction="4" accessable="true" desc="１．保険年度末Vレート">
			Vrate_accu(t,0)
		</formula>

		<!-- 契約者保険年度Vrate　ここから -->
		<formula name="ContractorYearV" paras="t,z" pvh="P" fraction="4" desc="契約者保険年度Vrate">
			Vrate_accu(t,z)
		</formula>
		<formula name="ContractorVrate" pvh="P" fraction="4" accessable="true" desc="３．契約者用Vレート">
			if(state==4 || state==2||kaisu==1||state==7){
				<!-- 払済まだは払込期間終了後 -->
				(1-f_12(f))*ContractorYearV(t,z)+(f_12(f))*ContractorYearV(t+1,z)
			}elseIf(state==1 || state==6){
				<!-- 払込期間中まだは免除 -->
				(1-f_12(f1))*ContractorYearV(t1,z)+(f_12(f1))*ContractorYearV(t1+1,z)
			}else(0)
		</formula>
		
		<formula name="BizYearVrate_Overbar1">
			(SADD_x_l(x)+gamma_nashu*m_SaDD_x(x))/SaDD_x_m(x,mshushin)
		</formula>
		
		<formula name="BizYearV" paras="t,z" accessable="false" desc="事業末Vレート">
			if(kaisu&gt;1){	
				if(state==4){
					<!-- 払済 -->
					SingleV(t)
				}elseIf(state==1){
					<!-- 払込期間中 -->
					if(gen==5){
						max(
						if(t==0){0}else{
							if(m==99){
								if(round(SADD_x_l(x)/SaDD_x_m(x,mshushin),6)&lt;=PrateByYear){
									MultiV(t,z)
								}else{
									ADD_x_l(x+t)-PrateByYear*aDD_x_m(x+t,mshushin-t)
								-
								if(z==0){0}else{alpha*aDD_x_m(x+t,z-t)/SaDD_x_m(x,z)}
								}
							}else{
								if(round(BizYearVrate_Overbar1,6)&lt;=PrateByYear){
									MultiV(t,z)
								}else{
									ADD_x_l(x+t)+gamma_nashu*aDD_x(x+t)
									-
									(PrateByYear+gamma_nashu)*aDD_x_m(x+t,mshushin-t)
									-
									if(z==0){0}else{alpha*aDD_x_m(x+t,z-t)/SaDD_x_m(x,z)}
								}
							}
						}
						,0)
						}elseIf(gen==3||gen==4){
						if(t==0){0}else{
							if(m==99){
								if(round(SADD_x_l(x)/SaDD_x_m(x,mshushin),6)&lt;=PrateByYear){
									MultiV(t,z)
								}else{
								max{
									ADD_x_l(x+t)-PrateByYear*aDD_x_m(x+t,mshushin-t)
									-
									if(z==0){0}else{alpha*aDD_x_m(x+t,z-t)/SaDD_x_m(x,z)}
								,0}
								}
							}else{
								if(round(BizYearVrate_Overbar1,6)&lt;=PrateByYear){
									MultiV(t,z)
								}else{
									max{
										ADD_x_l(x+t)+gamma_nashu*aDD_x(x+t)
										-
										(PrateByYear+gamma_nashu)*aDD_x_m(x+t,mshushin-t)
										-
										if(z==0){0}else{alpha*aDD_x_m(x+t,z-t)/SaDD_x_m(x,z)}
									,0}
								}
							}
						}
					}else{
						MultiV(t,z)
					}
				}elseIf(state==6){
					<!-- 免除 -->
					SingleV(t)
				}elseIf(state==2){
					<!-- 払込期間終了後 -->
					SingleV(t)
				}elseIf(state==7){
					if(SAS!=0){
						live(t,tEX)
					}else{
						dead(t,tEX,fEX)
					}
				}else(0)
			}elseIf(kaisu==1){
				<!-- 一時払 -->
				SingleV(t)
			}else{0}
		</formula>
		
		<formula name="calBizYearV" fraction="4" desc="事業末用Vレート">
			BizYearV(t,z)
		</formula>
		
	</ReserveFund>

	<!-- 解約返戻金　ここから -->
	<SurrenderFee desc="解約返戻金">
		<formula name="sigma" paras="t" desc="Sigmaσ">
			0.015*max{1-t/min(mshushin,10),0}
		</formula>
		<formula name="tDeadWrate" paras="t" pvh="P" desc="Wrate死亡部分">
			max{dead(t,tEX,fEX),0}
		</formula>
		<formula name="tLiveWrate" paras="t" pvh="P" desc="Wrate生存部分">
			max{live(t,tEX),0}
		</formula>
		<formula name="tWrate" paras="t" pvh="P">
			if(state==1 || state==6){
				<!-- 払込期間中まだは免除 -->
				round{max{ContractorYearV(t,0)-sigma(t),0},4}
			}else{
				max{ContractorYearV(t,0),0}
			}
		</formula>
		<formula name="DeadWrate" fraction="4" pvh="P" desc="死亡解約返戻金レート">
			(1-f_12(f))*tDeadWrate(t)+f_12(f)*tDeadWrate(t+1)
		</formula>
		<formula name="LiveWrate" fraction="4" pvh="P" desc="生存解約返戻金レート">
			(1-f_12(f))*tLiveWrate(t)+f_12(f)*tLiveWrate(t+1)
		</formula>
		<formula name="Wrate" fraction="4" pvh="P" accessable="true" desc="１．解約返戻金Wレート">
			<formula name="Wrate_Overbar1">
				if(12*t1+f1-12*t-f&lt;0){
					<!-- 払込年月数-経過年月数<0の場合、t,fをt1,f1に読み替え -->
					(1-f_12(f1))*tWrate(t1)+f_12(f1)*tWrate(t1+1)
				}else{
					(1-f_12(f))*tWrate(t)+f_12(f)*tWrate(t+1)
				}				
			</formula>
			<formula name="Wrate_Overbar2">
				v^ve*round((1-f_12(f1))*tWrate(t1)+f_12(f1)*tWrate(t1+1),4)
			</formula>
			<formula name="Wrate_Overbar3">
				v^ve*round((1-f_12(f1))*min{tWrate(t1),MultiV_Vbase(t1)}
					+
				f_12(f1)*min{tWrate(t1+1),MultiV_Vbase(t1+1)},4)
			</formula>
			<formula name="MultiV_Vbase" pvh="V" paras="t" fraction="4">
				MultiV(t,min(m,5))
			</formula>
			<formula name="Wrate_Overbar4">
				(1-f_12(f))*tWrate(t)+f_12(f)*tWrate(t+1)
			</formula>
			if(state==4){
				<!-- 払済 -->
				Wrate_Overbar4
			}elseIf(state==1 || state==6){
				if(PremiumAbolishSign==1){
					Wrate_Overbar1
				}elseIf(contractDate&gt;=20080202){
					Wrate_Overbar2
				}else{
					Wrate_Overbar3
				}
			}elseIf(state==2||kaisu==1){
				<!-- 払込期間終了後 -->
				Wrate_Overbar4
			}elseIf(state==7){
				if(SAS!=0){
					LiveWrate
				}else{
					DeadWrate
				}
			}else(0)
		</formula>
	</SurrenderFee>
</Formula-definition>